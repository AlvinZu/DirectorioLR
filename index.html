<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DirectorioPro LR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  
  <!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-messaging-compat.js"></script>
  
  <!-- Icono App -->
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512x512.png">
    <link rel="apple-touch-icon" href="icon-180x180.png">
    <link rel="manifest" href="manifest.json">
  
    <style>
      /* Estilos para el selector de categorías */
#categoryFilter {
    min-width: 200px;
    transition: all 0.3s ease;
}

#categoryFilter:hover {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Estilo para móviles */
@media (max-width: 640px) {
    #offersScreen .flex.items-center {
        margin: 1rem;
        flex-direction: column;
        align-items: flex-start;
    }
    
    #categoryFilter {
        margin-top: 2rem, 2rem;      
        width: 100%;
        
    }
  }
      /* Estilo para la flecha del dropdown */
#categoryFilter + div i {
    color: blue;
    right: 12px;
}
      
      /* Margen en la pantalla de ofertas */
#offersScreen {
    margin-left: 1rem; /* Margen izquierdo adicional si lo prefieres */
}

   /* Margen para móviles */
@media (min-width: 640px) {
    #offersScreen {
        margin-left: .8rem;
    }  
}
      
           
       /*Código base*/
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .search-highlight {
            background-color: #FEF08A;
        }
        
        /*Detalle de la corona*/
        .membership-badge {
            position: absolute;
            top: -12px;
            right: -12px;
            width: 34px;
            height: 34px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            color: gold;
            background: black;
        }
      
        /*Detalle del borde de la tarjeta*/
        .premium-card {
            border: 4px solid black;
            position: relative;
            overflow: hidden;

        }
        
         /*Detalle de las estrellas*/
        .premium-card::after {
            content: '⭐⭐⭐⭐⭐';
            position: absolute;
            top: 10px;
            right: -30px;
            background: black;
            color: gold;
            padding: 2px 30px;
            transform: rotate(45deg);
            font-size: 12px;
            font-weight: bold;
        }
      
      /* Estilos para el slider */
.swiper {
    width: 100%;
    height: 200px;
}

.swiper-slide {
    position: relative;
    text-align: center;
    background: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
}

.swiper-slide img {
    display: block;
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.swiper-slide-content {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
    color: white;
    padding: 1rem;
    text-align: left;
}

.swiper-button-next, .swiper-button-prev {
    color: white !important;
    background: rgba(0,0,0,0.5);
    padding: 1rem;
    border-radius: 50%;
}

.swiper-pagination-bullet-active {
    background: white !important;
}
      
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Header -->
  
  <!-- Login Screen -->
<div id="loginScreen" class="min-h-screen bg-gray-50 flex flex-col justify-center py-12 sm:px-6 lg:px-8 hidden">
  <div class="text-center mb-8">
  <div class="sm:mx-auto sm:w-full sm:max-w-md">    
    <i class="fas fa-briefcase text-5xl text-blue-600"></i>
    <h1 class="text-3xl font-bold text-gray-800 mt-4">Bienvenido a DirectorioPro</h1>
    <p class="text-gray-500">Inicia sesión o regístrate para continuar</p>    
  </div>
  </div>

  <div class="mt-8 sm:mx-auto sm:w-full sm:max-w-md">
    <div class="bg-white py-8 px-4 shadow sm:rounded-lg sm:px-10">
      <div class="space-y-6">
        <div>
          <label for="email" class="block text-sm font-medium text-gray-700">
            Correo electrónico
          </label>
          <div class="mt-1">
            <input id="email" name="email" type="email" autocomplete="email" required class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
          </div>
        </div>

        <div>
          <label for="password" class="block text-sm font-medium text-gray-700">
            Contraseña
          </label>
          <div class="mt-1">
            <input id="password" name="password" type="password" autocomplete="current-password" required class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
          </div>
        </div>

          

        <div>
          <button id="loginBtn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            Iniciar sesión
          </button>
        </div>
      </div>

      <div class="mt-6">
        <div class="relative">
          <div class="absolute inset-0 flex items-center">
            <div class="w-full border-t border-gray-300"></div>
          </div>
          <div class="relative flex justify-center text-sm">
            <span class="px-2 bg-white text-gray-500">
              O inicia sesión con
            </span>
          </div>
        </div>

        <div class="mt-6 grid grid-cols-1 gap-3">
          <div>
            <button id="googleSignIn" class="w-full inline-flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
              <img class="h-5 w-5 mr-2" src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
              Google
            </button>
          </div>
        </div>
      </div>

      <div class="mt-6 text-center">
        <p class="text-sm text-gray-600">
          ¿No tienes una cuenta? 
          <button id="registerBtn" class="font-medium text-blue-600 hover:text-blue-500">
            Regístrate
          </button>
        </p>
      </div>
    </div>
  </div>
</div>
  
  
  <!-- Register Screen -->
<div id="registerScreen" class="min-h-screen bg-gray-50 flex flex-col justify-center py-12 sm:px-6 lg:px-8 hidden">
  <div class="text-center mb-8">
    <div class="sm:mx-auto sm:w-full sm:max-w-md">    
      <i class="fas fa-briefcase text-5xl text-blue-600"></i>
      <h1 class="text-3xl font-bold text-gray-800 mt-4">Crear cuenta</h1>
      <p class="text-gray-500">Regístrate para acceder al directorio</p>    
    </div>
  </div>

  <div class="mt-8 sm:mx-auto sm:w-full sm:max-w-md">
    <div class="bg-white py-8 px-4 shadow sm:rounded-lg sm:px-10">
      <div class="space-y-6">
        <div>
          <label for="registerEmail" class="block text-sm font-medium text-gray-700">
            Correo electrónico
          </label>
          <div class="mt-1">
            <input id="registerEmail" name="email" type="email" autocomplete="email" required class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
          </div>
        </div>

        <div>
          <label for="registerPassword" class="block text-sm font-medium text-gray-700">
            Contraseña
          </label>
          <div class="mt-1">
            <input id="registerPassword" name="password" type="password" autocomplete="new-password" required class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
          </div>
        </div>

        <div>
          <label for="confirmPassword" class="block text-sm font-medium text-gray-700">
            Confirmar contraseña
          </label>
          <div class="mt-1">
            <input id="confirmPassword" name="confirmPassword" type="password" autocomplete="new-password" required class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
          </div>
        </div>

        <div>
          <label for="registerRole" class="block text-sm font-medium text-gray-700">
            ¿Eres un cliente o una empresa?
          </label>
          <div class="mt-1">
            <select id="registerRole" name="role" required class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
              <option value="client">Cliente</option>
            <!-- <option value="business">Empresa</option> -->
            </select>
          </div>
        </div>

        <div>
          <button id="registerSubmitBtn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            Registrarse
          </button>
        </div>
      </div>

      <div class="mt-6 text-center">
        <p class="text-sm text-gray-600">
          ¿Ya tienes una cuenta? 
          <button id="backToLogin" class="font-medium text-blue-600 hover:text-blue-500">
            Iniciar sesión
          </button>
        </p>
      </div>
    </div>
  </div>
</div>
  
  
  
          
    <header id="appHeader" class="bg-blue-600 text-white shadow-lg hidden">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fas fa-briefcase text-2xl"></i>
                <h1 class="text-xl font-bold">DirectorioPro Los Reyes</h1>
            </div>
            <nav class="hidden md:flex space-x-6">
                <button id="homeBtn" class="hover:text-blue-200 font-medium flex items-center">
                    <i class="fas fa-home mr-1"></i> Inicio
                </button>
                <button id="featuredBtn" class="hover:text-blue-200 font-medium flex items-center">
                    <i class="fas fa-star mr-1"></i> Destacados
                </button>
              <button id="offersBtn" class="hover:text-blue-200 font-medium flex items-center">
              <i class="fas fa-tag mr-1"></i> Ofertas Exclusivas
              </button>
              
            </nav>
            <button class="md:hidden text-xl" id="mobileMenuBtn">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        
        <!-- Mobile Menu -->
        <div id="mobileMenu" class="hidden md:hidden bg-blue-700 py-2 px-4">
          
            <button id="mobileHomeBtn" class="block w-full text-left py-2 hover:bg-blue-600 rounded px-2">
                <i class="fas fa-home mr-2"></i> Inicio
            </button>
            <button id="mobileFeaturedBtn" class="block w-full text-left py-2 hover:bg-blue-600 rounded px-2">
                <i class="fas fa-star mr-2"></i> Destacados
            </button>
            <button id="mobileOffersBtn" class="block w-full text-left py-2 hover:bg-blue-600 rounded px-2">
            <i class="fas fa-tag mr-2"></i> Ofertas Exclusivas
            </button>
            <button id="adminPanelBtn" class="hidden bg-yellow-400 text-black font-bold px-3 py-1 rounded hover:bg-yellow-500">
    <i class="fas fa-user-shield mr-1"></i> Admin
</button>
            <button id="mobileAccountBtn" class="block w-full text-left py-2 hover:bg-blue-600 rounded px-2">
        <i class="fas fa-user-circle mr-2"></i> Mi Cuenta
    </button>
          <button id="logoutBtn" class="hidden text-white hover:text-blue-200">
  <i class="fas fa-sign-out-alt mr-1"></i> Salir
</button>
        </div>
    </header>

  <!-- Home Screen -->
        <div id="homeScreen" class="fade-in">
  
  <!-- Slider de Empresas Destacadas -->
  <div id="sliderContainer">
    <section class="swiper mt-1">
        <div class="swiper-wrapper">
            <!-- Slides dinámicos se agregarán aquí con JavaScript -->
        </div>
      
        
        <!-- Navegación -->
        <div class="swiper-button-next"></div>
        <div class="swiper-button-prev"></div>
        
        <!-- Paginación -->
        <div class="swiper-pagination"></div>
    </section>
    </div>
  
    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        
            <!-- Search Section -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8 -mt-4">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Encuentra profesionales cerca de ti</h2>
                <div class="relative">
                    <input type="text" id="searchInput" placeholder="Buscar por nombre o categoría..." 
                           class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <i class="fas fa-search absolute right-4 top-4 text-gray-400"></i>
                </div>
                <div id="searchResults" class="hidden mt-2 border border-gray-200 rounded-lg max-h-60 overflow-y-auto"></div>
            </div>
            
            <!-- Sección de Categorías -->
            <div class="mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Explora por categorías</h2>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4" id="categoriesGrid">
                    <!-- Categories will be loaded here by JavaScript -->
                </div>
            </div>
            
            <!-- Featured Professionals Preview - Vista previa de profesionales destacados -->
            <div class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Profesionales destacados</h2>
                    <button id="viewAllFeatured" class="text-blue-600 hover:underline">Ver todos</button>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="featuredPreview">
                    <!-- La vista previa destacada se cargará aquí -->
                </div>
            </div>
        </div>
        
        <!-- Category Professionals Screen - Pantalla Categoría Profesionales -->
        <div id="categoryScreen" class="hidden fade-in">
          <div class="container mx-auto px-2 py-2">
            <div class="flex items-center mb-6">
                <button id="backFromCategory" class="mr-4 text-blue-600 hover:text-blue-800">
                    <i class="fas fa-arrow-left text-xl"></i>
                </button>
                <h2 class="text-2xl font-bold text-gray-800" id="categoryTitle"></h2>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="professionalsGrid">
                <!-- Professionals will be loaded here by JavaScript -->
            </div>
        </div>
          </div>
        
        <!-- Professional Details Screen - Pantalla de detalles profesionales -->
        <div id="detailsScreen" class="hidden fade-in">
            <div class="flex items-center mb-6">
                <button id="backFromDetails" class="mr-4 text-blue-600 hover:text-blue-800">
                    <i class="fas fa-arrow-left text-xl"></i>
                </button>
                <h2 class="text-2xl font-bold text-gray-800">Detalles del profesional</h2>
            </div>
            
            <div class="bg-white rounded-lg shadow-md overflow-hidden" id="professionalDetails">
                <!-- Details will be loaded here by JavaScript -->
            </div>
        </div>
        
        <!-- Featured Professionals Screen - Pantalla de profesionales destacados -->
        <div id="featuredScreen" class="hidden fade-in">
          <div class="container mx-auto px-2 py-2">
            <div class="flex items-center mb-6">
                <button id="backFromFeatured" class="mr-4 text-blue-600 hover:text-blue-800">
                    <i class="fas fa-arrow-left text-xl"></i>
                </button>
                <h2 class="text-2xl font-bold text-gray-800">Profesionales destacados</h2>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="featuredGrid">
                <!-- Featured professionals will be loaded here by JavaScript -->
            </div>
        </div>
          </div>
    </main>
    
    
               <!-- Offers Screen - Pantalla de Ofertas -->
<div id="offersScreen" class="hidden fade-in">
    <div class="flex items-center mb-6">
        <button id="backFromOffers" class="mr-4 text-blue-600 hover:text-blue-800">
            <i class="fas fa-arrow-left text-xl"></i>
        </button>
        <h2 class="text-2xl font-bold text-gray-800 mr-4">Ofertas Exclusivas</h2>
        <div class="relative">
            <select id="categoryFilter" 
                    class="appearance-none bg-white border border-gray-300 rounded-lg py-2 px-4 pr-8 leading-tight focus:outline-none focus:border-blue-500">
                <option value="all">Todas las categorías</option>
                <!-- Las opciones se generarán dinámicamente -->
            </select>
            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                <i class="fas fa-chevron-down"></i>
            </div>
        </div>
    </div>
    
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="offersGrid">
        <!-- Las ofertas se cargarán aquí -->
    </div>
</div>
  
  <!-- Pantalla de Mi Cuenta de perfil -->
  <div id="profileScreen" class="hidden fade-in bg-white md:bg-gray-50 min-h-screen">
    <div class="container mx-auto max-w-lg">        

        <div class="p-6 flex flex-col items-center space-y-4">
            <h2 class="text-3xl font-bold text-gray-800 mb-4">Mi Cuenta</h2>
            <div class="relative">
                <img id="profileImage" class="w-32 h-32 rounded-full object-cover border-4 border-gray-100 shadow-md" src="" alt="Foto de perfil">
                <div id="profileIconFallback" class="hidden w-32 h-32 rounded-full bg-blue-500 flex items-center justify-center border-4 border-gray-100 shadow-md">
                    <i class="fas fa-user text-6xl text-white"></i>
                </div>
            </div>

            <div class="text-center">
                <h3 id="profileName" class="text-2xl font-bold text-gray-900"></h3>
                <p id="profileEmail" class="text-gray-500"></p>
                <span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold mt-2 px-2.5 py-0.5 rounded-full">Cliente</span>
            </div>

            <div class="flex items-center space-x-3 text-gray-600 bg-gray-100 px-4 py-2 rounded-lg">
                <i class="far fa-calendar-alt"></i>
                <span id="profileJoinedDate"></span>
            </div>

            <button id="enableNotificationsBtn" class="w-full flex justify-between items-center p-3 bg-green-400 hover:bg-green-500 rounded-lg mt-2">
    <span><i class="fas fa-bell mr-2"></i> Activar Notificaciones</span>
    <i class="fas fa-chevron-right text-gray-400"></i>
</button>
            <button id="profileSignOutBtn" class="w-full max-w-xs bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-colors shadow-lg">
                Cerrar Sesión
            </button>

            <div class="w-full max-w-xs pt-4 space-y-2">
                <button id="profileChangePasswordBtn" class="w-full flex justify-between items-center p-3 hover:bg-gray-100 rounded-lg">
                    <span>Cambiar Contraseña</span>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </button>
                <button id="profileDeleteAccountBtn" class="w-full flex justify-between items-center p-3 hover:bg-gray-100 rounded-lg">
                    <span class="text-red-600">Eliminar Cuenta</span>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </button>
            </div>
        </div>
    </div>
</div>
  
  <div id="adminScreen" class="hidden fade-in p-6">
    <div class="max-w-7xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Panel de Administrador</h1>
                <p class="text-gray-600">Gestiona los profesionales del directorio.</p>
            </div>
            <button id="addProfessionalBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors flex items-center">
                <i class="fas fa-plus mr-2"></i> Agregar Profesional
            </button>
        </div>

        <div class="bg-white rounded-lg shadow-md overflow-x-auto">
            <table class="w-full table-auto">
                <thead class="bg-gray-50 border-b-2 border-gray-200">
                    <tr>
                        <th class="p-3 text-sm font-semibold tracking-wide text-left">Nombre</th>
                        <th class="p-3 text-sm font-semibold tracking-wide text-left">Categoría</th>
                        <th class="p-3 text-sm font-semibold tracking-wide text-left">Membresía</th>
                        <th class="p-3 text-sm font-semibold tracking-wide text-left">Acciones</th>
                    </tr>
                </thead>
                <tbody id="adminProfessionalsList">
                    <tr><td colspan="4" class="p-4 text-center text-gray-500">Cargando...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
  
  <div id="professionalModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b">
            <h2 id="modalTitle" class="text-2xl font-bold">Agregar Nuevo Profesional</h2>
        </div>
        <form id="professionalForm" class="p-6 space-y-4">
            <input type="hidden" id="professionalId">

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" id="profName" placeholder="Nombre del Profesional" class="p-2 border rounded w-full" required>
                <input type="text" id="profCategory" placeholder="Categoría (Ej: Dentistas)" class="p-2 border rounded w-full" required>
                <input type="text" id="profSpecialty" placeholder="Especialidad" class="p-2 border rounded w-full">
                <input type="text" id="profPhone" placeholder="Teléfono" class="p-2 border rounded w-full">
                <input type="text" id="profAddress" placeholder="Dirección" class="p-2 border rounded w-full">
                <input type="text" id="profSchedule" placeholder="Horario" class="p-2 border rounded w-full">
                <input type="text" id="profPrice" placeholder="Precio o texto (Ej: Agenda Ahora)" class="p-2 border rounded w-full">
                <input type="text" id="profExperience" placeholder="Experiencia" class="p-2 border rounded w-full">
                <input type="text" id="profEducation" placeholder="Educación" class="p-2 border rounded w-full">
                <input type="text" id="profImage" placeholder="URL de la Imagen de Perfil" class="p-2 border rounded w-full">
            </div>
            
            <textarea id="profDescription" placeholder="Descripción" class="p-2 border rounded w-full h-24"></textarea>
            <textarea id="profServices" placeholder="Servicios (separados por coma)" class="p-2 border rounded w-full h-24"></textarea>
            <textarea id="profGallery" placeholder="URLs de Galería (separadas por coma)" class="p-2 border rounded w-full h-24"></textarea>
            
            <div class="flex items-center space-x-6 pt-2">
                <div class="flex items-center">
                    <input type="checkbox" id="profFeatured" class="mr-2 h-5 w-5">
                    <label for="profFeatured">Destacado</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="profPremium" class="mr-2 h-5 w-5">
                    <label for="profPremium">Membresía Premium</label>
                </div>
                 <div class="flex items-center">
                    <input type="checkbox" id="profShowInSlider" class="mr-2 h-5 w-5">
                    <label for="profShowInSlider">Mostrar en Slider</label>
                </div>
            </div>

            <div class="pt-4 flex justify-end space-x-3">
                <button type="button" id="cancelProfessionalBtn" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">Cancelar</button>
                <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Guardar Cambios</button>
            </div>
        </form>
    </div>
</div>
              
    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div>
                    <h3 class="text-xl font-bold mb-4">DirectorioPro Los Reyes</h3>
                    <p class="text-gray-300">Conectando profesionales con clientes desde 2025.</p>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Enlaces rápidos</h3>
                    <ul class="space-y-2">
                        <li><button id="footerHomeBtn" class="text-gray-300 hover:text-white">Inicio</button></li>
                        <li><button id="footerFeaturedBtn" class="text-gray-300 hover:text-white">Destacados</button></li>
                        
                    </ul>
                </div>
              
                <div>
                    <h3 class="text-xl font-bold mb-4">Contacto</h3>
                    <p class="text-gray-300"><i class="fas fa-phone mr-2"></i>4434770618</p>
                  
                  <div class="border-t border-gray-700 mt-8 pt-6 text-center text-gray-400">
                    <h3 class="text-xl font-bold mb-4">Anunciate con Nosotros</h3>
                    <p class="text-gray-300">Tenemos Planes de 6 meses y 1 Año a un super precio.</p>
                </div>
            </div>
            
            <!-- Lightbox -->
<div id="lightbox" class="hidden fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4">
    <div class="max-w-4xl w-full relative">
        <img id="lightbox-img" src="" alt="" class="rounded-lg max-h-[80vh] mx-auto">
        <button onclick="closeLightbox()" class="absolute -top-8 right-0 text-white text-2xl hover:text-gray-300">
            <i class="fas fa-times"></i>
        </button>
    </div>
</div>
                            
        </div>
    </footer>
    
    <script>
      // Variable global para almacenar los profesionales que cargaremos desde Firestore.
    let professionals = [];
      
      const contactConfig = {
    // Categorías configurar cuales botones aparecen    
        'Dentistas': ['call'],  
        'Nutriólogos': ['whatsapp'],  
        'Quiroprácticos': ['whatsapp'],  
        'Doctores': ['call'],  
        'Fisioterapeutas': ['whatsapp', 'call'],  
        'Tiendas de ropa': ['whatsapp', 'call'],  
        'Venta de suplementos': ['whatsapp'],  
        'Barberías': ['whatsapp', 'call'],  
        'Tiendas de Pinturas': ['call'],  
        'Carpinteros': ['whatsapp'],  
        'Electricistas': ['whatsapp', 'call'],  
        'Plomeros': ['call'],  
        'Fotógrafos': ['call'],  
        'Protección Civil': ['call'],  
        'Abogados': ['whatsapp'],  
        'Psicólogos': ['whatsapp', 'call'],  
        'Veterinarios': ['whatsapp', 'call'],  
        'Mecánicos': ['call'],  
        'Técnicos en Computadoras': ['whatsapp'],  
        'Tatuadores': ['whatsapp', 'call'],  
        'Restaurantes': ['call'],  
        'Pezcaderías': ['call'],  
        'Construcción': ['whatsapp', 'call'],
        'Arquitectos': ['whatsapp', 'call'],    
        'Rotulistas': ['whatsapp'],  
        'Llanteras': ['call'],  
        'Sitios de Taxis': ['call'],  
        'Masajistas': ['whatsapp'],  
        'Vinaterías': ['call'],  
        'Vidrierías': ['whatsapp', 'call'],  
        'Herreros': ['call'],  
        'Ferreterías': ['whatsapp', 'call'],  
        'Loncherías': ['call'],  
        'Lavanderías': ['whatsapp', 'call'],
        'Pastelerías': ['call'],  
        'Cafeterías': ['call'],  
        'Pizzerías': ['call'],  
        'Pollerías': ['call'],  
        'Carnicerías': ['whatsapp', 'call'],  
        'Papelerías': ['whatsapp', 'call'],  
        'Imprentas': ['call'],  
        'Hoteles': ['call'],  
        'Talleres de Motos': ['call'],  
        'Productos de Limpieza': ['call'],  
        'Purificadoras':['whatsapp', 'call'],  
        'Policías': ['call'],  
        'Ambulancias': ['call'],
        'Panaderías': ['whatsapp', 'call'],
        'Reparación de Celulares': ['whatsapp', 'call'],
        'Agencias de Viajes':['call'],
        'Refaccionarias':['whatsapp', 'call'],
        'Florerías':['whatsapp', 'call'],
        'Podólogos':['whatsapp', 'call'],
        'Quintas':['whatsapp', 'call'],
        'Renta de Muebles':['whatsapp', 'call'],
        'Músicos': ['whatsapp', 'call'],
        'Tablaroqueros': ['whatsapp', 'call'],
        'Renta de Inflables': ['whatsapp', 'call'],
        'Cámaras de Seguridad': ['whatsapp', 'call'],
        'Paneles Solares': ['whatsapp', 'call'],
        'Auto Lavados': ['whatsapp', 'call'],
        'Funerarias': ['call'],
        'Cruz Roja': ['call'],
        'Escuelas de Ingles': ['whatsapp', 'call'],
        'Cerrajeros': ['whatsapp', 'call'],
        'Deportes': ['whatsapp', 'call'],
        'Perfumerías': ['whatsapp'],
       'Hospitales': ['call'],
        'Belleza': ['whatsapp', 'call'],
        'Productos de Belleza': ['whatsapp', 'call'],
        'Joyerías': ['whatsapp', 'call'],
        'Comida Rápida': ['whatsapp', 'call'],
        'Aires Acondicionados': ['whatsapp', 'call'],
        'Sociedad Cooperativa de Ahorros y Préstamos': ['call'],
        'Ginecólogos': ['whatsapp', 'call'],
        'Supermercados': ['call']
        
};
      
        
      
      
      // Configuración de Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyBM91yvFBEU9NDSEZKQyFHU6bhqCPgY3Uc",
        authDomain: "directoriopro-los-reyes.firebaseapp.com",
        projectId: "directoriopro-los-reyes",
        storageBucket: "directoriopro-los-reyes.firebasestorage.app",
        messagingSenderId: "689785400797",
        appId: "1:689785400797:web:5b91b320d6aa70ae669a34"
    };

  // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const analytics = firebase.analytics();
    const auth = firebase.auth();
    const db = firebase.firestore();
      

        // DOM Elements
    const homeScreen = document.getElementById('homeScreen');
    const categoryScreen = document.getElementById('categoryScreen');
    const detailsScreen = document.getElementById('detailsScreen');
    const featuredScreen = document.getElementById('featuredScreen');
    const offersScreen = document.getElementById('offersScreen');
    const profileScreen = document.getElementById('profileScreen');
    const adminScreen = document.getElementById('adminScreen');
    const categoriesGrid = document.getElementById('categoriesGrid');
    const professionalsGrid = document.getElementById('professionalsGrid');
    const professionalDetails = document.getElementById('professionalDetails');
    const featuredGrid = document.getElementById('featuredGrid');
    const featuredPreview = document.getElementById('featuredPreview');
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    const categoryTitle = document.getElementById('categoryTitle');
    const mobileMenu = document.getElementById('mobileMenu');
      
      // --- NUEVA FUNCIÓN ---
    // Carga todos los profesionales desde Firestore y los almacena en la variable global.
    // Es asíncrona porque la lectura de la base de datos toma tiempo.
    async function loadProfessionalsFromFirestore() {
        try {
            const snapshot = await db.collection('professionals').orderBy('name').get();
            // Mapeamos los documentos a un formato que el resto del código entiende,
            // añadiendo el ID del documento, que es crucial para editar y borrar.
            professionals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            console.log(`DirectorioPro: ${professionals.length} perfiles cargados desde Firestore.`);
        } catch (error) {
            console.error("Error crítico al cargar perfiles desde Firestore: ", error);
            alert("No se pudieron cargar los datos del directorio. Por favor, recarga la página.");
        }
    }
        
        // En tu función init() agrega:
async function init() {
    // 1. Mostrar un estado de carga mientras se obtienen los datos.
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('registerScreen').classList.add('hidden');
    homeScreen.classList.remove('hidden'); // Mostramos el home para que se vea algo.
    categoriesGrid.innerHTML = '<p class="col-span-full text-center text-gray-500">Cargando...</p>';
    featuredPreview.innerHTML = '<p class="col-span-full text-center text-gray-500">Cargando...</p>';

    // 2. Cargar los profesionales de Firestore y esperar a que termine.
    await loadProfessionalsFromFirestore();
    
    // 3. Una vez cargados los datos, inicializar el resto de la aplicación.
    loadCategories();
    loadFeaturedPreview();
    setupEventListeners();
    initSwiper();
    history.replaceState({ screen: 'home' }, '');
    
    // La lógica para mostrar la pantalla correcta (login vs home) se manejará en el observador de autenticación
    handleInitialScreen(); 
}

// Nueva función para inicializar el slider
function initSwiper() {
    const swiperWrapper = document.querySelector('.swiper-wrapper');
    
    // Filtrar empresas con showInSlider: true
    const sliderCompanies = professionals.filter(pro => 
        pro.showInSlider && pro.image
    );
    
    // Generar slides
    swiperWrapper.innerHTML = sliderCompanies.map(company => `
        <div class="swiper-slide">
            <img src="${company.image}" alt="${company.name}">
            <div class="swiper-slide-content">
                <h3 class="text-xl font-bold">${company.name}</h3>
                
                <button class="mt-2 bg-white/20 backdrop-blur-sm px-4 py-1 rounded-full text-xs hover:bg-white/30 transition-all"
                        onclick="showProfessionalDetails('${company.id}')">
                    Ver Perfil
                </button>
            </div>
        </div>
    `).join('');

    // Inicializar Swiper
    new Swiper('.swiper', {
        loop: true,
        autoplay: {
            delay: 2500,
        },
        navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
        },
        pagination: {
            el: '.swiper-pagination',
            clickable: true,
        },
        breakpoints: {
            640: {
                slidesPerView: 2,
                spaceBetween: 20,
            },
            1024: {
                slidesPerView: 3,
                spaceBetween: 30,
            },
        }
    });
}
        
        // Load categories into the grid
        function loadCategories() {
    // Deriva las categorías del array 'professionals' y las ordena alfabéticamente.
    const categories = [...new Set(professionals.map(pro => pro.category))].sort();
    
    categoriesGrid.innerHTML = ''; // Limpia el contenido anterior
    
    categories.forEach(category => {
        const icon = getCategoryIcon(category);
        const categoryElement = document.createElement('div');
        categoryElement.className = 'bg-white rounded-lg shadow-md p-4 flex flex-col items-center cursor-pointer hover:shadow-lg transition-shadow';
        categoryElement.innerHTML = `
            <div class="text-4xl text-blue-600 mb-2">${icon}</div>
            <h3 class="text-lg font-medium text-center">${category}</h3>
        `;
        categoryElement.addEventListener('click', () => {
            showCategoryProfessionals(category);
        });
        categoriesGrid.appendChild(categoryElement);
    });
}
        
        // Los Iconos para cada categoría
        function getCategoryIcon(category) {
            const icons = {
                'Dentistas': '<i class="fas fa-tooth"></i>',
                'Nutriólogos': '<i class="fas fa-apple-alt"></i>',
                'Quiroprácticos': '<i class="fas fa-bone"></i>',
                'Doctores': '<i class="fas fa-user-md"></i>',
                'Fisioterapeutas': '<i class="fas fa-hand-holding-heart"></i>',
                'Tiendas de ropa': '<i class="fas fa-tshirt"></i>',
                'Tiendas de suplementos': '<i class="fas fa-pills"></i>',
                'Barberías': '<i class="fas fa-cut"></i>',
                'Tiendas de Pinturas': '<i class="fas fa-paint-roller"></i>',
                'Carpinteros': '<i class="fas fa-hammer"></i>',
                'Electricistas': '<i class="fas fa-bolt"></i>',
                'Plomeros': '<i class="fas fa-faucet"></i>',
                'Fotógrafos': '<i class="fas fa-camera-retro"></i>',
                'Protección Civil': '<i class="fas fa-shield-alt"></i>',
                'Abogados': '<i class="fas fa-gavel"></i>',
                'Psicólogos': '<i class="fas fa-brain"></i>',
                'Veterinarios': '<i class="fas fa-paw"></i>',
                'Mecánicos': '<i class="fas fa-car"></i>',
                'Técnicos en Computadoras': '<i class="fas fa-laptop"></i>',
                'Tatuadores': '<i class="fas fa-dragon"></i>',
        'Restaurantes': '<i class="fas fa-utensils"></i>',
        'Pezcaderías': '<i class="fas fa-shrimp"></i>',
        'Construcción': '<i class="fas fa-hard-hat"></i>',
        'Arquitectos': '<i class="fas fa-drafting-compass"></i>',       
        'Rotulistas': '<i class="fas fa-paint-brush"></i>',
        'Llanteras': '<i class="fas fa-car"></i>',
        'Sitios de Taxis': '<i class="fas fa-taxi"></i>',
        'Masajistas': '<i class="fas fa-spa"></i>',
        'Vinaterías': '<i class="fas fa-wine-bottle"></i>',
        'Vidrierías': '<i class="fas fa-store"></i>',
        'Herreros': '<i class="fas fa-tools"></i>',
        'Ferreterías': '<i class="fas fa-toolbox"></i>',
        'Loncherías': '<i class="fas fa-bread-slice"></i>',
        'Lavanderías': '<i class="fas fa-soap"></i>',
        'Pastelerías': '<i class="fas fa-birthday-cake"></i>',
        'Cafeterías': '<i class="fas fa-coffee"></i>',
        'Pizzerías': '<i class="fas fa-pizza-slice"></i>',
        'Pollerías': '<i class="fas fa-drumstick-bite"></i>',
        'Carnicerías': '<i class="fas fa-drumstick-bite"></i>',
        'Papelerías': '<i class="fas fa-pencil"></i>',
        'Imprentas': '<i class="fas fa-print"></i>',
        'Hoteles': '<i class="fas fa-hotel"></i>',
        'Talleres de Motos': '<i class="fas fa-motorcycle"></i>',
        'Productos de Limpieza': '<i class="fas fa-broom"></i>',
        'Purificadoras de Agua': '<i class="fas fa-water"></i>',
        'Policías': '<i class="fas fa-shield-alt"></i>',
        'Ambulancias': '<i class="fas fa-ambulance"></i>',        
        'Panaderías': '<i class="fas fa-bread-slice"></i>',
        'Reparación de Celulares': '<i class="fas fa-mobile-alt"></i>',
        'Agencias de Viajes': '<i class="fas fa-plane-departure"></i>',
        'Refaccionarias': '<i class="fas fa-car-side"></i>',
        'Florerías': '<i class="fas fa-spa"></i>',
        'Podólogos': '<i class="fas fa-shoe-prints"></i>',
        'Quintas': '<i class="fas fa-home"></i>',
        'Renta de Muebles': '<i class="fas fa-couch"></i>',
        'Músicos': '<i class="fas fa-music"></i>',       
        'Tablaroqueros': '<i class="fas fa-border-style"></i>',
        'Renta de Inflables': '<i class="fas fa-cloud"></i>',
        'Cámaras de Seguridad': '<i class="fas fa-camera"></i>',
        'Paneles Solares': '<i class="fas fa-solar-panel"></i>',
        'Auto Lavados': '<i class="fas fa-car"></i>',
        'Funerarias': '<i class="fas fa-monument"></i>',
        'Cruz Roja': '<i class="fas fa-cross"></i>',
        'Escuelas de Ingles': '<i class="fas fa-language"></i>',
        'Cerrajeros': '<i class="fas fa-key"></i>',
        'Deportes': '<i class="fas fa-medal"></i>',
        'Perfumerías': '<i class="fas fa-spray-can-sparkles"></i>',
        'Hospitales': '<i class="fas fa-hospital"></i>',
        'Belleza': '<i class="fas fa-crown"></i>',
        'Productos de Belleza': '<i class="fas fa-spa"></i>',
        'Joyerías': '<i class="fas fa-gem"></i>',
        'Comida Rápida': '<i class="fas fa-hamburger"></i>',
        'Aires Acondicionados': '<i class="fas fa-fan"></i>',
        'Sociedad Cooperativa de Ahorros y Préstamos': '<i class="fas fa-coins"></i>',
        'Ginecólogos': '<i class="fas fa-venus"></i><i class="fas fa-stethoscope ml-1"></i>',
        'Supermercados': '<i class="fas fa-shopping-cart"></i>'
    };
            
            return icons[category] || '<i class="fas fa-briefcase"></i>';
        }
        
      
      

// Estado de usuario
let currentUser = null;
let userRole = null;

// Observador de autenticación
// Variable para guardar nuestra función de "escucha" en tiempo real.
let authUnsubscribe = null;
// Variable global para saber si el usuario actual es admin
let isCurrentUserAdmin = false;

// Observador de autenticación MEJORADO
auth.onAuthStateChanged(user => {
  // Si ya estábamos "escuchando" a un usuario anterior, dejamos de hacerlo.
  if (authUnsubscribe) {
    authUnsubscribe();
  }

  if (user) {
    currentUser = user;
    
    // Usamos .onSnapshot() para escuchar en tiempo real.
    // Esto se ejecutará inmediatamente, y OTRA VEZ si los datos cambian (es decir, cuando se crea el documento).
    authUnsubscribe = db.collection('users').doc(user.uid).onSnapshot(doc => {
      if (doc.exists) {
        // ¡Éxito! El documento existe (ya sea porque estaba antes o porque se acaba de crear).
        userRole = doc.data().role;
          // --- INICIA LA MODIFICACIÓN ---
        // Verificamos si el campo isAdmin es true
        if (doc.data().isAdmin === true) {
          isCurrentUserAdmin = true;
          // Mostramos el botón para ir al panel de administrador
          document.getElementById('adminPanelBtn').classList.remove('hidden');
        } else {
          isCurrentUserAdmin = false;
          document.getElementById('adminPanelBtn').classList.add('hidden');
        }
        // --- FIN DE LA MODIFICACIÓN ---
        document.getElementById('appHeader').classList.remove('hidden');
        // --- LÍNEA de Analitics ---
    // Registra un evento de login en Analytics.
    analytics.logEvent('login', { method: user.providerData[0].providerId });
    // --- FIN LÍNEA Analitics ---
        showScreen('home');

        // Opcional: una vez que lo encontramos, podemos dejar de escuchar para ahorrar recursos.
        if (authUnsubscribe) {
          authUnsubscribe();
        }
      }
      // Si el documento NO existe todavía, NO hacemos nada.
      // onSnapshot se volverá a ejecutar solo en cuanto la función de Google lo cree.
    }, error => {
        // Manejar posibles errores de lectura de Firestore
        console.error("Error al escuchar el perfil del usuario:", error);
        auth.signOut(); // Si hay un error de permisos, desconectar.
    });

  } else {
    currentUser = null;
    userRole = null;
      // Asegúrate de resetear la variable al cerrar sesión
    isCurrentUserAdmin = false; 
    document.getElementById('adminPanelBtn').classList.add('hidden');
    document.getElementById('appHeader').classList.add('hidden');
    showScreen('login');
  }
});

// Función para mostrar la pantalla de login
function showLoginScreen() {
  document.getElementById('loginScreen').classList.remove('hidden');
  homeScreen.classList.add('hidden');
  categoryScreen.classList.add('hidden');
  // ... ocultar otras pantallas ...
  currentUser = null;
  userRole = null;
}

// Función para mostrar pantalla según rol
function showScreen(screen) {
  // Ocultar login
  document.getElementById('loginScreen').classList.add('hidden');
  
  // Mostrar pantalla según el rol
  if (screen === 'home') {
    homeScreen.classList.remove('hidden');
    document.getElementById('sliderContainer').classList.remove('hidden');
    
    // Mostrar contenido diferente según rol
    if (userRole === 'business') {
      document.querySelector('h1').textContent = 'Panel de Empresa';
      // Aquí podrías agregar funcionalidades específicas para empresas
    } else {
      document.querySelector('h1').textContent = 'DirectorioPro Los Reyes';
    }
  }
  // ... otras pantallas ...
}

      
// Login con correo/contraseña
document.getElementById('loginBtn').addEventListener('click', () => {
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;

  if (!email || !password) {
    alert("Por favor, ingresa tu correo y contraseña.");
    return;
  }

  auth.signInWithEmailAndPassword(email, password)
    .then((userCredential) => {
      // Inicio de sesión exitoso. El sistema te redirigirá automáticamente.
      console.log('Inicio de sesión exitoso para:', userCredential.user.email);
    })
    .catch((error) => {
      console.error("Error de autenticación:", error);
      let message = "Ocurrió un error al iniciar sesión.";
      if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
          message = "Correo electrónico o contraseña incorrectos. Por favor, verifica tus datos.";
      } else if (error.code === 'auth/invalid-email') {
          message = "El formato del correo electrónico no es válido.";
      }
      alert(message);
    });
});

      
// Login con Google
document.getElementById('googleSignIn').addEventListener('click', () => {
    const provider = new firebase.auth.GoogleAuthProvider();

    auth.signInWithPopup(provider)
        .then((result) => {
            const user = result.user;
            const userRef = db.collection('users').doc(user.uid);

            // Verificar si el usuario ya existe en Firestore
            return userRef.get().then((doc) => {
                if (doc.exists) {
                    // El usuario ya existe, solo actualizamos su último login.
                    return userRef.update({
                        lastLogin: new Date()
                    });
                } else {
                    // **AQUÍ ESTÁ LA CORRECCIÓN**
                    // Si el usuario es nuevo, lo registramos automáticamente como cliente.
                    return userRef.set({
                        email: user.email,
                        role: 'client', // Asignamos el rol de cliente por defecto
                        createdAt: new Date(),
                        lastLogin: new Date()
                    });
                }
            });
        }).catch((error) => {
            // Manejo de errores, como que el usuario cierre la ventana de Google.
            console.error("Error con el inicio de sesión de Google:", error);
            if (error.code !== 'auth/popup-closed-by-user') {
               alert("Hubo un problema al intentar iniciar sesión con Google. Por favor, intenta de nuevo.");
            }
        });
});
      

// Registro
// Mostrar pantalla de registro
document.getElementById('registerBtn').addEventListener('click', () => {
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('registerScreen').classList.remove('hidden');
});

// Volver al login desde registro
document.getElementById('backToLogin').addEventListener('click', () => {
  document.getElementById('registerScreen').classList.add('hidden');
  document.getElementById('loginScreen').classList.remove('hidden');
});

// Función de registro mejorada
document.getElementById('registerSubmitBtn').addEventListener('click', registerUser);

function registerUser() {
  const email = document.getElementById('registerEmail').value;
  const password = document.getElementById('registerPassword').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  const role = document.getElementById('registerRole').value;
  
  if (!email || !password || !confirmPassword) {
    alert("Por favor completa todos los campos");
    return;
  }
  
  if (password !== confirmPassword) {
    alert("Las contraseñas no coinciden");
    return;
  }
  
  auth.createUserWithEmailAndPassword(email, password)
    .then((userCredential) => {
      // Guardar rol en Firestore
      db.collection('users').doc(userCredential.user.uid).set({
        role: role,
        email: email,
        createdAt: new Date()
      }).then(() => {
        // Cerrar pantalla de registro
        document.getElementById('registerScreen').classList.add('hidden');
        // Mostrar mensaje de éxito
        alert("¡Registro exitoso! Ahora puedes iniciar sesión");
        // Limpiar formulario
        document.getElementById('registerEmail').value = '';
        document.getElementById('registerPassword').value = '';
        document.getElementById('confirmPassword').value = '';
      });
    })
    .catch((error) => {
      console.error("Error en registro:", error);
      alert(error.message);
    });
}
      
      
        // Show professionals for a specific category
        function showCategoryProfessionals(category) {
            const categoryPros = professionals.filter(pro => pro.category === category);
            
            categoryTitle.textContent = category;
            professionalsGrid.innerHTML = '';
            
            categoryPros.forEach(pro => {
                const proCard = createProfessionalCard(pro);
                professionalsGrid.appendChild(proCard);
            });
            
            showScreen('category');
        }
        
        // Create a professional card element - Crear una tarjeta de profesional
        function createProfessionalCard(professional) {
            const card = document.createElement('div');
            card.className = `bg-white rounded-lg shadow-md overflow-hidden ${professional.membership === 'premium' ? 'premium-card' : ''}`;
            
            card.innerHTML = `
                <div class="relative">
                    <img src="${professional.image}" alt="${professional.name}" class="w-full h-48 object-cover">
                    ${professional.membership === 'premium' ? '' : 
                    `<div class="membership-badge bg-gray-200 text-gray-800">
                        <i class="fas fa-user"></i>
                    </div>`}
                </div>
                <div class="p-4">
                    <h3 class="text-xl font-bold mb-1">${professional.name}</h3>
                    <div id="stars-container-${professional.id}" class="flex items-center mb-2"></div>
                    <div id="stars-container-${professional.id}" class="flex items-center mb-2">
    <!-- Las estrellas se cargarán aquí -->
</div>
                    <p class="text-blue-600 font-medium mb-2">${professional.specialty}</p>
                    <p class="text-gray-600 text-sm mb-3 line-clamp-2">${professional.description}</p>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-800 font-medium">${professional.price}</span>
                        <button class="details-btn bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors" 
                                data-id="${professional.id}">
                            Ver Detalles
                        </button>
                    </div>
                </div>
            `;
            getAndDisplayStars(professional.id, card.querySelector(`#stars-container-${professional.id}`));
          
            return card;
        }
      
      // --- NUEVAS FUNCIONES PARA EL PANEL DE ADMINISTRADOR ---

// Carga y muestra la lista de profesionales en la tabla del admin.
function cargarProfesionalesEnAdmin() {
    const listContainer = document.getElementById('adminProfessionalsList');
    if (!listContainer) return; // Salir si el elemento no existe
    
    listContainer.innerHTML = ''; // Limpiar la tabla
    
    if (professionals.length === 0) {
        listContainer.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">No hay profesionales para mostrar.</td></tr>';
        return;
    }
    
    let content = '';
    // Ordenamos los profesionales por nombre para una mejor visualización
    [...professionals].sort((a, b) => a.name.localeCompare(b.name)).forEach(pro => {
        const membershipType = pro.membership === true || pro.membership === 'premium' ? 'premium' : 'free';
        content += `
            <tr class="border-b hover:bg-gray-50">
                <td class="p-3 text-sm text-gray-700 font-medium">${pro.name}</td>
                <td class="p-3 text-sm text-gray-700">${pro.category}</td>
                <td class="p-3 text-sm text-gray-700">
                    <span class="p-1.5 text-xs font-medium uppercase tracking-wider rounded-md ${membershipType === 'premium' ? 'bg-yellow-200 text-yellow-800' : 'bg-gray-200 text-gray-800'}">
                        ${membershipType}
                    </span>
                </td>
                <td class="p-3 text-sm">
                    <button class="edit-btn text-blue-600 hover:text-blue-800 font-semibold" data-id="${pro.id}">Editar</button>
                    <button class="delete-btn text-red-600 hover:text-red-800 font-semibold ml-4" data-id="${pro.id}">Eliminar</button>
                </td>
            </tr>
        `;
    });
    listContainer.innerHTML = content;
}

// Abre el modal para agregar o editar
function openProfessionalModal(id = null) {
    const modal = document.getElementById('professionalModal');
    const form = document.getElementById('professionalForm');
    const modalTitle = document.getElementById('modalTitle');
    
    form.reset();
    
    if (id) {
        const pro = professionals.find(p => p.id === id);
        if (pro) {
            modalTitle.textContent = "Editar Profesional";
            document.getElementById('professionalId').value = pro.id;
            document.getElementById('profName').value = pro.name || '';
            document.getElementById('profCategory').value = pro.category || '';
            document.getElementById('profSpecialty').value = pro.specialty || '';
            document.getElementById('profPhone').value = pro.phone || '';
            document.getElementById('profAddress').value = pro.address || '';
            document.getElementById('profSchedule').value = pro.schedule || '';
            document.getElementById('profPrice').value = pro.price || '';
            document.getElementById('profExperience').value = pro.experience || '';
            document.getElementById('profEducation').value = pro.education || '';
            document.getElementById('profImage').value = pro.image || '';
            document.getElementById('profDescription').value = pro.description || '';
            document.getElementById('profServices').value = Array.isArray(pro.services) ? pro.services.join(', ') : '';
            document.getElementById('profGallery').value = Array.isArray(pro.gallery) ? pro.gallery.join(', ') : '';
            document.getElementById('profFeatured').checked = pro.featured === true;
            document.getElementById('profPremium').checked = pro.membership === true || pro.membership === 'premium';
            document.getElementById('profShowInSlider').checked = pro.showInSlider === true;
        }
    } else {
        modalTitle.textContent = "Agregar Nuevo Profesional";
        document.getElementById('professionalId').value = '';
    }
    
    modal.classList.remove('hidden');
}

// Cierra el modal
function closeProfessionalModal() {
    document.getElementById('professionalModal').classList.add('hidden');
}

// Guarda los cambios (crear o actualizar)
async function saveProfessional(event) {
    event.preventDefault();
    const id = document.getElementById('professionalId').value;

    const proData = {
        name: document.getElementById('profName').value,
        category: document.getElementById('profCategory').value,
        specialty: document.getElementById('profSpecialty').value,
        phone: document.getElementById('profPhone').value,
        address: document.getElementById('profAddress').value,
        schedule: document.getElementById('profSchedule').value,
        price: document.getElementById('profPrice').value,
        experience: document.getElementById('profExperience').value,
        education: document.getElementById('profEducation').value,
        image: document.getElementById('profImage').value,
        description: document.getElementById('profDescription').value,
        services: document.getElementById('profServices').value.split(',').map(s => s.trim()).filter(Boolean),
        gallery: document.getElementById('profGallery').value.split(',').map(s => s.trim()).filter(Boolean),
        featured: document.getElementById('profFeatured').checked,
        membership: document.getElementById('profPremium').checked, // Guardar como booleano
        showInSlider: document.getElementById('profShowInSlider').checked,
    };

    try {
        if (id) {
            await db.collection('professionals').doc(id).set(proData, { merge: true });
            alert("Profesional actualizado con éxito.");
        } else {
            await db.collection('professionals').add(proData);
            alert("Profesional agregado con éxito.");
        }
        closeProfessionalModal();
        await loadProfessionalsFromFirestore(); // Recargar datos
        cargarProfesionalesEnAdmin(); // Actualizar la vista del admin
    } catch (error) {
        console.error("Error al guardar el profesional: ", error);
        alert("Ocurrió un error al guardar.");
    }
}

// Elimina un profesional
async function deleteProfessional(id) {
    if (confirm("¿Estás seguro? Esta acción es irreversible.")) {
        try {
            await db.collection('professionals').doc(id).delete();
            alert("Profesional eliminado.");
            // Actualizar la UI sin recargar toda la página
            professionals = professionals.filter(p => p.id !== id);
            cargarProfesionalesEnAdmin(); 
        } catch (error) {
            console.error("Error al eliminar: ", error);
            alert("Ocurrió un error al eliminar.");
        }
    }
}
        
      //genera los botones de contactos
      function generateContactButtons(professional) {
    const config = contactConfig[professional.category] || ['call']; // Default: WhatsApp
    let buttons = '';
    
    const phoneNumber = professional.phone.replace(/\D/g, ''); // Limpia el número
    
    // Obtener el nombre completo
    const nombreCompleto = encodeURIComponent(professional.name); // Nombre completo codificado
    
    config.forEach(method => {
        if (method === 'whatsapp') {
            buttons += `
                <a href="https://wa.me/${phoneNumber}?text=Hola%20${nombreCompleto},%20vi%20tu%20perfil%20en%20DirectorioPro%20LR%20y%20me%20gustaría%20saber%20más%20sobre%20tus%20servicios" 
                   target="_blank" 
                   class="block bg-green-500 text-white text-center py-3 rounded-lg hover:bg-green-600 transition-colors">
                    <i class="fab fa-whatsapp mr-2"></i> Contactar por WhatsApp
                </a>
            `;
        }
        
        if (method === 'call') {
            const isEmergency = ['Policías', 'Ambulancias', 'Bomberos', 'Cruz Roja', 'Protección Civil'].includes(professional.category);
            buttons += `
                <a href="tel:${phoneNumber}" 
                   class="block ${isEmergency ? 'bg-red-500 emergency-btn' : 'bg-blue-500'} text-white text-center py-3 rounded-lg hover:${isEmergency ? 'bg-red-600' : 'bg-blue-600'} transition-colors">
                    <i class="fas fa-phone mr-2"></i> ${isEmergency ? 'Llamada de Emergencia' : 'Llamar ahora'}
                </a>
            `;
        }
    });
    
    return buttons;
}
      
      
      // Lightbox functions
function showLightbox(imgUrl) {
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightbox-img');
    lightboxImg.src = imgUrl;
    lightbox.classList.remove('hidden');
}

function closeLightbox() {
    document.getElementById('lightbox').classList.add('hidden');
}

// Cerrar al hacer clic fuera de la imagen
document.getElementById('lightbox').addEventListener('click', (e) => {
    if (e.target.id === 'lightbox') closeLightbox();
});
      
      
        // Show professional details - Detalles de los profesionales
        function showProfessionalDetails(id) {
    // Buscamos por el ID de string, sin convertirlo a número.
    const professional = professionals.find(pro => pro.id === id);
    
    if (!professional) {
        alert("Profesional no encontrado.");
        return;
    }
    
    analytics.logEvent('view_item', {
      item_id: `profesional_${professional.id}`,
      item_name: professional.name,
      item_category: professional.category
    });
    
    const membershipType = professional.membership === true || professional.membership === 'premium' ? 'premium' : 'free';
    const servicesHTML = (professional.services && Array.isArray(professional.services) && professional.services.length > 0)
        ? professional.services.map(service => `<li class="text-gray-700"><i class="fas fa-check text-blue-500 mr-2"></i>${service}</li>`).join('')
        : '<li class="text-gray-500">Servicios no especificados.</li>';

    const galleryHTML = (membershipType === 'premium' && professional.gallery && Array.isArray(professional.gallery) && professional.gallery.length > 0) ? `
    <div class="mt-8">
        <h4 class="text-xl font-bold mb-4 text-gray-800">Galería de Trabajos</h4>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 gallery-grid">
            ${professional.gallery.map(img => `
                <img src="${img}" alt="Trabajo de ${professional.name}" 
                     class="cursor-pointer w-full h-48 object-cover rounded-lg shadow-md hover:shadow-lg transition-transform transform hover:scale-105"
                     onclick="showLightbox('${img}')">
            `).join('')}
        </div>
    </div>` : '';

    professionalDetails.innerHTML = `
        <div class="md:flex">
            <div class="md:w-1/3 bg-gray-100 p-6 flex flex-col items-center text-center">
                 <div class="relative mb-4">
                    <img src="${professional.image || './Images/Logo.jpg'}" alt="${professional.name}" 
                         class="w-32 h-32 rounded-full object-cover border-4 border-white shadow-md">
                    ${membershipType === 'premium' ? 
                    `<div class="membership-badge"><i class="fas fa-crown"></i></div>` : ''}
                </div>
                <h3 class="text-xl font-bold">${professional.name}</h3>
                <p class="text-blue-600 font-medium">${professional.specialty || ''}</p>
                <p class="text-gray-600 mt-2">${professional.category}</p>
                <div class="mt-6 w-full space-y-3">
                    ${generateContactButtons(professional)}
                    <button id="shareBtn" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg w-full flex items-center justify-center hover:bg-yellow-600 transition-all">
                        <i class="fas fa-share-alt mr-2"></i>Compartir
                    </button>
                </div>
            </div>
            <div class="md:w-2/3 p-6">
                 <div class="mb-6">
                    <h4 class="text-lg font-bold mb-2 text-gray-800">Sobre mí</h4>
                    <p class="text-gray-700">${professional.description || 'Descripción no disponible.'}</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <h4 class="text-lg font-bold mb-2 text-gray-800">Servicios</h4>
                        <ul class="space-y-1">${servicesHTML}</ul>
                    </div>
                    <div>
                        <h4 class="text-lg font-bold mb-2 text-gray-800">Horario</h4>
                        <p class="text-gray-700"><i class="far fa-clock text-blue-500 mr-2"></i>${professional.schedule || 'No especificado'}</p>
                        <h4 class="text-lg font-bold mt-4 mb-2 text-gray-800">Experiencia</h4>
                        <p class="text-gray-700"><i class="fas fa-briefcase text-blue-500 mr-2"></i>${professional.experience || 'No especificada'}</p>
                    </div>
                </div>
                 ${professional.education ? `
                <div class="mb-6">
                    <h4 class="text-lg font-bold mb-2 text-gray-800">Educación</h4>
                    <p class="text-gray-700"><i class="fas fa-graduation-cap text-blue-500 mr-2"></i>${professional.education}</p>
                </div>` : ''}
                <div>
                    <h4 class="text-lg font-bold mb-2 text-gray-800">Ubicación</h4>
                    <p class="text-gray-700 mb-4"><i class="fas fa-map-marker-alt text-blue-500 mr-2"></i>${professional.address || 'No especificada'}</p>
                </div>
                ${galleryHTML}
            </div>
        </div>
    `;

    const shareButton = professionalDetails.querySelector('#shareBtn');
    if (shareButton) {
        shareButton.addEventListener('click', () => shareProfessional(id));
    }
    
    // setupRatingSection(id); // Descomenta si usas el sistema de valoración.
    showScreen('details');
}
        
      // ESTA ES LA FUNCIÓN PRINCIPAL DE COMPARTIR
async function shareProfessional(professionalId) {
    const professional = professionals.find(p => p.id == professionalId);
    if (!professional) return;

    const shareData = {
        title: 'DirectorioPro Los Reyes',
        text: `¡Te recomiendo a "${professional.name}"! Encuéntralos en DirectorioPro Los Reyes.`,
        url: `https://alvinzu.github.io/DirectorioLR/?id=${professional.id}`
    };

    if (navigator.share) {
        try {
            await navigator.share(shareData);
            console.log('¡Perfil compartido exitosamente!');
        } catch (err) {
            console.log('Error al compartir:', err);
        }
    } else {
        alert('La función de compartir no está disponible en este navegador.');
    }
  // Añade esto al final
    window.scrollTo(0, 0);
    document.body.scrollTop = 0;
    document.documentElement.scrollTop = 0;
}

// ESTA FUNCIÓN REVISA LA URL CUANDO LA APP CARGA
function handleInitialScreen() {
    const urlParams = new URLSearchParams(window.location.search);
    const professionalId = urlParams.get('id');

    if (professionalId) {
        // Si hay un ID, muestra los detalles de ese profesional
        history.replaceState({ screen: 'details' }, '');
        showProfessionalDetails(professionalId);
    } else {
        // Si no, muestra la pantalla de inicio
        history.replaceState({ screen: 'home' }, '');
        showScreen('home');
    }
}
      
        // Load featured professionals preview
        function loadFeaturedPreview() {
            const featuredPros = professionals.filter(pro => pro.featured).slice(0, 3);
            featuredPreview.innerHTML = '';
            
            featuredPros.forEach(pro => {
                const proCard = createProfessionalCard(pro);
                featuredPreview.appendChild(proCard);
            });
        }
        
        // Show all featured professionals
        function showAllFeatured() {
            const featuredPros = professionals.filter(pro => pro.featured);
            featuredGrid.innerHTML = '';
            
            featuredPros.forEach(pro => {
                const proCard = createProfessionalCard(pro);
                featuredGrid.appendChild(proCard);
            });
            
            showScreen('featured');
        }
        
        // Show the specified screen
        function showScreen(screen, pushState = true) {
    // Ocultar todas las pantallas principales
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('registerScreen').classList.add('hidden');
    homeScreen.classList.add('hidden');
    categoryScreen.classList.add('hidden');
    detailsScreen.classList.add('hidden');
    featuredScreen.classList.add('hidden');
    offersScreen.classList.add('hidden');
    document.getElementById('profileScreen').classList.add('hidden');
    document.getElementById('adminScreen').classList.add('hidden');
    document.getElementById('sliderContainer').classList.add('hidden');

    if (!currentUser && screen !== 'login' && screen !== 'register') {
        document.getElementById('loginScreen').classList.remove('hidden');
        return;
    }

    switch(screen) {
        case 'home':
            homeScreen.classList.remove('hidden');
            document.getElementById('sliderContainer').classList.remove('hidden');
            break;
        case 'category': categoryScreen.classList.remove('hidden'); break;
        case 'details': detailsScreen.classList.remove('hidden'); break;
        case 'featured': featuredScreen.classList.remove('hidden'); break;
        case 'offers': 
            offersScreen.classList.remove('hidden');
            loadExclusiveOffers();
            break;
        case 'profile':
            document.getElementById('profileScreen').classList.remove('hidden');
            loadProfileData(); 
            break;
        case 'admin':
            if (isCurrentUserAdmin) {
                document.getElementById('adminScreen').classList.remove('hidden');
                cargarProfesionalesEnAdmin(); // Cargar datos al mostrar el panel
            } else {
                 showScreen('home'); // Si no es admin, mandar a home
                 alert("Acceso denegado.");
            }
            break;
        case 'login': document.getElementById('loginScreen').classList.remove('hidden'); break;
        case 'register': document.getElementById('registerScreen').classList.remove('hidden'); break;
        default:
             homeScreen.classList.remove('hidden');
             document.getElementById('sliderContainer').classList.remove('hidden');
    }
    
    if (pushState) {
        history.pushState({ screen: screen }, '', `#${screen}`);
    }

    window.scrollTo(0, 0); // Scroll al inicio en cada cambio de pantalla
}
      
           
      
      
      // Logout
document.getElementById('logoutBtn').addEventListener('click', () => {
  auth.signOut().then(() => {
    // Limpiar los campos del formulario de inicio de sesión
    document.getElementById('email').value = '';
    document.getElementById('password').value = '';

    showLoginScreen();
  });
});

      // Manejar el evento de retroceso específico para iOS
window.addEventListener('pagehide', function(event) {
    if (event.persisted) {
        // Forzar scroll al inicio cuando la página se restaure desde la caché
        window.scrollTo(0, 0);
    }
});

window.addEventListener('pageshow', function(event) {
    if (event.persisted) {
        // Forzar scroll al inicio cuando la página se restaure desde la caché
        window.scrollTo(0, 0);
    }
});
      
      
// Mostrar/ocultar botón de logout
auth.onAuthStateChanged(user => {
  if (user) {
    document.getElementById('logoutBtn').classList.remove('hidden');
  } else {
    document.getElementById('logoutBtn').classList.add('hidden');
  }
});
      
      
      // Manejar el botón de retroceso del navegador
window.addEventListener('popstate', (event) => {
    const state = event.state;
    if (state && state.screen) {
        showScreen(state.screen, false);
    } else {
        showScreen('home', false);
    }
// Añade esto para scroll al inicio en retroceso
    window.scrollTo(0, 0);
    document.body.scrollTop = 0;
    document.documentElement.scrollTop = 0;
});

      
        
      // Función para cargar ofertas
function loadExclusiveOffers(selectedCategory = 'all') {
    const offersGrid = document.getElementById('offersGrid');
    offersGrid.innerHTML = '';

    // Obtener categorías únicas que tienen ofertas
    const categoriesWithOffers = [...new Set(
        professionals
            .filter(pro => pro.offers && pro.offers.length > 0)
            .map(pro => pro.category)
    )];

    // Actualizar opciones del filtro
    const categoryFilter = document.getElementById('categoryFilter');
    categoryFilter.innerHTML = `
        <option value="all">Todas las categorías</option>
        ${categoriesWithOffers.map(category => `
            <option value="${category}" ${selectedCategory === category ? 'selected' : ''}>
                ${category}
            </option>
        `).join('')}
    `;

    // Generar ofertas
    professionals.forEach(pro => {
        if(pro.membership === 'premium' && pro.offers && pro.offers.length > 0) {
            if(selectedCategory === 'all' || pro.category === selectedCategory) {
                pro.offers.forEach(offer => {
                    const offerCard = document.createElement('div');
                    offerCard.className = 'bg-white rounded-lg shadow-md overflow-hidden relative';
                    offerCard.innerHTML = `
                        <div class="p-4 bg-gradient-to-r from-blue-100 to-purple-100">
                            <div class="flex items-center justify-between mb-2">
                                <span class="bg-blue-600 text-white px-3 py-1 rounded-full text-sm">
                                    ${offer.discount}
                                </span>
                                <span class="text-gray-500 text-sm">${offer.validity}</span>
                            </div>
                            <h3 class="text-xl font-bold mb-2">${offer.title}</h3>
                            <p class="text-gray-600 mb-4">${offer.description}</p>
                            <div class="bg-yellow-50 p-3 rounded-lg">
                                <p class="text-sm font-semibold text-yellow-800">Condiciones:</p>
                                <p class="text-sm text-yellow-700">${offer.conditions}</p>
                            </div>
                            <div class="mt-4 flex items-center">
                                <img src="${pro.image}" class="w-10 h-10 rounded-full mr-3">
                                <div>
                                    <p class="font-medium">${pro.name}</p>
                                    <p class="text-sm text-gray-500">${pro.category}</p>
                                </div>
                            </div>
                            <button class="mt-4 w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors"
                                    onclick="showProfessionalDetails(${pro.id})">
                                Ver Perfil Completo
                            </button>
                        </div>
                    `;
                    offersGrid.appendChild(offerCard);
                });
            }
        }
    });
}


// --- AÑADIR AL FINAL DE TU SCRIPT ---

// Inicializar Firebase Messaging
const messaging = firebase.messaging();

// Función para solicitar permiso y guardar el token
function solicitarPermisoNotificaciones() {
  let serviceWorkerRegistration; // Variable para guardar el registro

  console.log('Solicitando permiso para notificaciones...');
  
  Notification.requestPermission().then((permission) => {
    if (permission === 'granted') {
      console.log('Permiso de notificación concedido.');
      // 1. Primero, registramos el Service Worker y esperamos a que se complete.
      return navigator.serviceWorker.register('/DirectorioLR/firebase-messaging-sw.js');
    } else {
      console.log('Permiso de notificación denegado.');
      alert('No has permitido las notificaciones.');
      throw new Error('Permiso denegado');
    }
  }).then((registration) => {
    console.log('Service Worker registrado con éxito:', registration);
    serviceWorkerRegistration = registration; // Guardamos el registro
    // 2. Ahora que tenemos el registro, pedimos el token de Firebase.
    return messaging.getToken({ serviceWorkerRegistration: registration });
  }).then(token => {
    // 3. Con el token en mano, lo guardamos en Firestore.
    if (token) {
      console.log('Token FCM obtenido:', token);
      db.collection('fcmTokens').doc(token).set({
        userId: currentUser.uid,
        createdAt: new Date()
      });
      alert('¡Gracias! Has activado las notificaciones.');
    }
  }).catch(err => {
    console.error('Error durante el proceso de notificaciones:', err);
    alert('Ocurrió un error al activar las notificaciones. Revisa la consola (F12) para más detalles.');
  });
}


        
      
      // =======================================================
// ========== LÓGICA DEL SISTEMA DE VALORACIÓN ==========
// =======================================================

/**
 * Genera y muestra las estrellas (llenas, media, vacías) en un contenedor.
 * @param {number} average - El promedio de valoración (ej. 4.7).
 * @param {number} count - El número total de valoraciones.
 * @param {HTMLElement} container - El elemento div donde se insertarán las estrellas.
 */
function displayStars(average, count, container) {
    if (!container) return;
    container.innerHTML = ''; // Limpiar contenedor
    const avg = parseFloat(average) || 0;
    const num = parseInt(count) || 0;

    for (let i = 1; i <= 5; i++) {
        const starIcon = document.createElement('i');
        if (i <= avg) {
            starIcon.className = "fas fa-star text-yellow-400"; // Estrella llena
        } else if (i - 0.5 <= avg) {
            starIcon.className = "fas fa-star-half-alt text-yellow-400"; // Media estrella
        } else {
            starIcon.className = "far fa-star text-yellow-400"; // Estrella vacía
        }
        container.appendChild(starIcon);
    }

    if (num > 0) {
        const ratingText = document.createElement('span');
        ratingText.className = "ml-2 text-sm text-gray-500";
        ratingText.textContent = `${avg.toFixed(1)} (${num} ${num === 1 ? 'valoración' : 'valoraciones'})`;
        container.appendChild(ratingText);
    } else {
        const noRatingText = document.createElement('span');
        noRatingText.className = "ml-2 text-sm text-gray-400";
        noRatingText.textContent = "Sin valoraciones";
        container.appendChild(noRatingText);
    }
}

/**
 * Obtiene los datos de valoración de Firestore y los muestra.
 * @param {string} professionalId - El ID del profesional.
 * @param {HTMLElement} container - El contenedor para las estrellas.
 */
async function getAndDisplayStars(professionalId, container) {
    try {
        const docRef = db.collection('ratings').doc(String(professionalId));
        const docSnap = await docRef.get();

        if (docSnap.exists) {
            const data = docSnap.data();
            displayStars(data.averageRating, data.ratingCount, container);
        } else {
            displayStars(0, 0, container);
        }
    } catch (error) {
        console.error("Error al obtener valoración:", error);
        displayStars(0, 0, container);
    }
}

/**
 * Prepara la sección de valoración en la pantalla de detalles.
 * @param {string} professionalId - El ID del profesional.
 */
async function setupRatingSection(professionalId) {
    const displayContainer = document.getElementById('details-stars-display');
    const inputContainer = document.getElementById('user-rating-input-container');
    const interactiveStars = document.getElementById('interactive-stars');
    const ratingFeedback = document.getElementById('rating-feedback');
    
    // 1. Mostrar siempre el promedio actual
    await getAndDisplayStars(professionalId, displayContainer);
    
    // 2. Mostrar la opción de votar solo a clientes
    if (userRole === 'client' && currentUser) {
        inputContainer.classList.remove('hidden');
        ratingFeedback.textContent = "";

        // 3. Verificar si este cliente ya votó
        const voteDoc = await db.collection('ratings').doc(String(professionalId)).collection('votes').doc(currentUser.uid).get();

        if (voteDoc.exists) {
            ratingFeedback.textContent = `Ya has valorado este servicio con ${voteDoc.data().rating} estrellas.`;
            interactiveStars.classList.add('hidden'); // Ocultar estrellas para votar
        } else {
            interactiveStars.classList.remove('hidden'); // Mostrar estrellas
            
            // 4. Añadir interactividad a las estrellas para votar
            const stars = interactiveStars.querySelectorAll('i');
            stars.forEach(star => {
                star.addEventListener('mouseover', () => highlightStars(stars, star.dataset.value));
                star.addEventListener('mouseout', () => highlightStars(stars, 0)); // Reset on mouse out
                star.addEventListener('click', () => submitRating(professionalId, star.dataset.value, stars));
            });
        }
    }
}

// Función de ayuda para el efecto hover
function highlightStars(stars, value) {
    stars.forEach(s => {
        s.className = s.dataset.value <= value ? "fas fa-star text-yellow-500" : "far fa-star text-gray-300";
    });
}

// Función de ayuda para el efecto hover en las estrellas
function highlightStars(stars, value) {
    stars.forEach(s => {
        s.className = s.dataset.value <= value ? "fas fa-star text-yellow-500" : "far fa-star text-gray-300";
    });
}

/**
 * Envía la valoración a Firestore usando una transacción para seguridad.
 * @param {string} professionalId - El ID del profesional.
 * @param {number} ratingValue - La valoración del usuario (1-5).
 * @param {NodeListOf<HTMLElement>} stars - La lista de elementos de estrella.
 */
async function submitRating(professionalId, ratingValue, stars) {
    if (!currentUser) return;
    const rating = parseInt(ratingValue);
    const professionalIdStr = String(professionalId);
    const userId = currentUser.uid;

    const ratingDocRef = db.collection('ratings').doc(professionalIdStr);
    const voteDocRef = ratingDocRef.collection('votes').doc(userId);
    
    document.getElementById('rating-feedback').textContent = "Guardando tu valoración...";

    try {
        await db.runTransaction(async (transaction) => {
            const voteDoc = await transaction.get(voteDocRef);
            if (voteDoc.exists) {
                throw "¡Ya has valorado este profesional!";
            }

            const ratingDoc = await transaction.get(ratingDocRef);
            let newCount = 1;
            let newAverage = rating;

            if (ratingDoc.exists) {
                const data = ratingDoc.data();
                const oldCount = data.ratingCount || 0;
                const oldAverage = data.averageRating || 0;
                newCount = oldCount + 1;
                newAverage = ((oldAverage * oldCount) + rating) / newCount;
            }
            
            transaction.set(ratingDocRef, {
                averageRating: newAverage,
                ratingCount: newCount
            }, { merge: true });

            transaction.set(voteDocRef, { rating: rating });
        });
        
        document.getElementById('rating-feedback').textContent = "¡Gracias por tu valoración!";
        stars.forEach(s => s.style.pointerEvents = 'none'); // Deshabilitar más clics
        getAndDisplayStars(professionalIdStr, document.getElementById('details-stars-display')); // Actualizar promedio

    } catch (error) {
        console.error("Error al enviar valoración: ", error);
        document.getElementById('rating-feedback').textContent = "Error: " + error;
    }
}
      
      
      // --- FUNCIÓN PARA CARGAR LOS DATOS DEL PERFIL ---
function loadProfileData() {
    if (!currentUser) return; // Salir si no hay usuario

    // Referencias a los elementos del DOM
    const profileImage = document.getElementById('profileImage');
    const profileIconFallback = document.getElementById('profileIconFallback');
    const profileName = document.getElementById('profileName');
    const profileEmail = document.getElementById('profileEmail');
    const profileJoinedDate = document.getElementById('profileJoinedDate');

    // Cargar imagen de perfil o mostrar icono de fallback
    if (currentUser.photoURL) {
        profileImage.src = currentUser.photoURL;
        profileImage.classList.remove('hidden');
        profileIconFallback.classList.add('hidden');
    } else {
        profileImage.classList.add('hidden');
        profileIconFallback.classList.remove('hidden');
    }

    // Cargar nombre (si no existe, usar el email) y correo
    profileName.textContent = currentUser.displayName || 'Usuario';
    profileEmail.textContent = currentUser.email;

    // Cargar y formatear la fecha de registro
    const creationDate = new Date(currentUser.metadata.creationTime);
    profileJoinedDate.textContent = `Se unió el ${creationDate.toLocaleDateString('es-MX')}`;
}
// ======================================
      
      
        // Setup search functionality
        function setupSearch() {
            searchInput.addEventListener('input', () => {
                const query = searchInput.value.trim().toLowerCase();
                
                if (query.length === 0) {
                    searchResults.classList.add('hidden');
                    return;
                }
                
                // Remove accents and special characters for better search
                const normalizedQuery = query.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                
                // Search in professionals and categories
                const results = [];
                
                // Search in categories
                categories.forEach(category => {
                    const normalizedCategory = category.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    if (normalizedCategory.includes(normalizedQuery)) {
                        results.push({
                            type: 'category',
                            name: category,
                            match: category
                        });
                    }
                });
                
                // Search in professionals
                professionals.forEach(pro => {
                    const normalizedName = pro.name.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    const normalizedCategory = pro.category.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    const normalizedSpecialty = pro.specialty.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    
                    if (normalizedName.includes(normalizedQuery) || 
                        normalizedCategory.includes(normalizedQuery) || 
                        normalizedSpecialty.includes(normalizedQuery)) {
                        
                        // Highlight the matching part
                        let matchField = '';
                        let matchText = '';
                        
                        if (normalizedName.includes(normalizedQuery)) {
                            matchField = 'name';
                            const startIdx = normalizedName.indexOf(normalizedQuery);
                            matchText = pro.name.substring(startIdx, startIdx + query.length);
                        } else if (normalizedSpecialty.includes(normalizedQuery)) {
                            matchField = 'specialty';
                            const startIdx = normalizedSpecialty.indexOf(normalizedQuery);
                            matchText = pro.specialty.substring(startIdx, startIdx + query.length);
                        } else {
                            matchField = 'category';
                            const startIdx = normalizedCategory.indexOf(normalizedQuery);
                            matchText = pro.category.substring(startIdx, startIdx + query.length);
                        }
                        
                        results.push({
                            type: 'professional',
                            id: pro.id,
                            name: pro.name,
                            category: pro.category,
                            specialty: pro.specialty,
                            matchField: matchField,
                            matchText: matchText
                        });
                    }
                });
                
                // Display results
                if (results.length > 0) {
                    searchResults.innerHTML = '';
                    results.forEach(result => {
                        const resultElement = document.createElement('div');
                        resultElement.className = 'p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-0';
                        
                        if (result.type === 'category') {
                            resultElement.innerHTML = `
                                <div class="flex items-center">
                                    <i class="fas fa-folder mr-3 text-blue-500"></i>
                                    <div>
                                        <p class="font-medium">${result.name}</p>
                                        <p class="text-sm text-gray-500">Categoría</p>
                                    </div>
                                </div>
                            `;
                            
                            resultElement.addEventListener('click', () => {
                                showCategoryProfessionals(result.name);
                                searchInput.value = '';
                                searchResults.classList.add('hidden');
                            });
                        } else {
                            // Highlight the matching text
                            let displayName = result.name;
                            let displayCategory = result.category;
                            let displaySpecialty = result.specialty;
                            
                            if (result.matchField === 'name') {
                                displayName = result.name.replace(
                                    new RegExp(result.matchText, 'i'), 
                                    `<span class="search-highlight">${result.matchText}</span>`
                                );
                            } else if (result.matchField === 'specialty') {
                                displaySpecialty = result.specialty.replace(
                                    new RegExp(result.matchText, 'i'), 
                                    `<span class="search-highlight">${result.matchText}</span>`
                                );
                            } else {
                                displayCategory = result.category.replace(
                                    new RegExp(result.matchText, 'i'), 
                                    `<span class="search-highlight">${result.matchText}</span>`
                                );
                            }
                            
                            resultElement.innerHTML = `
                                <div class="flex items-start">
                                    <img src="${professionals.find(p => p.id === result.id).image}" 
                                         class="w-10 h-10 rounded-full object-cover mr-3">
                                    <div>
                                        <p class="font-medium">${displayName}</p>
                                        <p class="text-sm">${displaySpecialty}</p>
                                        <p class="text-xs text-gray-500">${displayCategory}</p>
                                    </div>
                                </div>
                            `;
                            
                            resultElement.addEventListener('click', () => {
                                showProfessionalDetails(result.id);
                                searchInput.value = '';
                                searchResults.classList.add('hidden');
                            });
                        }
                        
                        searchResults.appendChild(resultElement);
                    });
                    
                    searchResults.classList.remove('hidden');
                } else {
                    searchResults.innerHTML = '<div class="p-3 text-gray-500">No se encontraron resultados</div>';
                    searchResults.classList.remove('hidden');
                }
            });
            
            // Hide results when clicking outside
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.classList.add('hidden');
                }
            });
        }
        
        // Setup event listeners
        function setupEventListeners() {
    // Listeners de navegación existentes
    document.getElementById('categoryFilter').addEventListener('change', (e) => loadExclusiveOffers(e.target.value));
    document.getElementById('adminPanelBtn').addEventListener('click', () => showScreen('admin'));
    document.getElementById('offersBtn').addEventListener('click', () => showScreen('offers'));
    document.getElementById('mobileOffersBtn').addEventListener('click', () => {
        showScreen('offers');
        mobileMenu.classList.add('hidden');
    });
    const accountButton = document.getElementById('accountBtn');
    if (accountButton) accountButton.addEventListener('click', () => showScreen('profile'));
    const mobileAccountButton = document.getElementById('mobileAccountBtn');
    if (mobileAccountButton) mobileAccountButton.addEventListener('click', () => {
        showScreen('profile');
        if (mobileMenu) mobileMenu.classList.add('hidden');
    });
    document.getElementById('enableNotificationsBtn').addEventListener('click', solicitarPermisoNotificaciones);
    homeBtn.addEventListener('click', () => showScreen('home'));
    featuredBtn.addEventListener('click', showAllFeatured);
    mobileHomeBtn.addEventListener('click', () => {
        showScreen('home');
        mobileMenu.classList.add('hidden');
    });
    mobileFeaturedBtn.addEventListener('click', () => {
        showAllFeatured();
        mobileMenu.classList.add('hidden');
    });
    footerHomeBtn.addEventListener('click', () => showScreen('home'));
    footerFeaturedBtn.addEventListener('click', showAllFeatured);
    viewAllFeatured.addEventListener('click', showAllFeatured);
    backFromCategory.addEventListener('click', () => history.back());
    backFromDetails.addEventListener('click', () => history.back());
    backFromFeatured.addEventListener('click', () => history.back());
    document.getElementById('backFromOffers').addEventListener('click', () => history.back());
    mobileMenuBtn.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('details-btn')) {
            showProfessionalDetails(e.target.dataset.id);
        }
    });
            
          // --- ACCIONES DE LOS BOTONES DEL PERFIL ---

// 1. Cerrar Sesión
document.getElementById('profileSignOutBtn').addEventListener('click', () => {
    if (confirm("¿Estás seguro de que deseas cerrar sesión?")) {
        auth.signOut();
    }
});

// 2. Cambiar Contraseña
document.getElementById('profileChangePasswordBtn').addEventListener('click', () => {
    if (!currentUser || !currentUser.email) return;

    // Firebase solo permite cambiar contraseña a usuarios registrados por email/pass
    const isEmailProvider = currentUser.providerData.some(provider => provider.providerId === 'password');
    
    if (!isEmailProvider) {
        alert("No puedes cambiar la contraseña porque iniciaste sesión con un proveedor externo (como Google).");
        return;
    }

    if (confirm("Se enviará un correo a tu dirección para restablecer tu contraseña. ¿Deseas continuar?")) {
        auth.sendPasswordResetEmail(currentUser.email)
            .then(() => {
                alert("¡Correo enviado! Revisa tu bandeja de entrada (y la carpeta de spam) para continuar.");
            })
            .catch(error => {
                console.error("Error al enviar correo de reseteo:", error);
                alert("Hubo un error al intentar enviar el correo. Por favor, intenta más tarde.");
            });
    }
});

// 3. Eliminar Cuenta
document.getElementById('profileDeleteAccountBtn').addEventListener('click', () => {
    if (!currentUser) return;

    const confirmationText = "¡Atención! Esta acción es irreversible y eliminará permanentemente tu cuenta y todos tus datos.\n\n¿Estás completamente seguro de que quieres eliminar tu cuenta?";
    
    if (confirm(confirmationText)) {
        currentUser.delete()
            .then(() => {
                alert("Tu cuenta ha sido eliminada exitosamente.");
                // onAuthStateChanged se encargará de redirigir al login
            })
            .catch(error => {
                console.error("Error al eliminar la cuenta:", error);
                // Este error común ocurre si el usuario no ha iniciado sesión recientemente
                if (error.code === 'auth/requires-recent-login') {
                    alert("Por seguridad, esta operación requiere que hayas iniciado sesión recientemente. Por favor, cierra sesión y vuelve a entrar para poder eliminar tu cuenta.");
                } else {
                    alert("Ocurrió un error al intentar eliminar tu cuenta.");
                }
            });
    }
});
          // --- NUEVOS LISTENERS PARA EL PANEL DE ADMINISTRADOR ---
    const addBtn = document.getElementById('addProfessionalBtn');
    if(addBtn) addBtn.addEventListener('click', () => openProfessionalModal());

    const cancelBtn = document.getElementById('cancelProfessionalBtn');
    if(cancelBtn) cancelBtn.addEventListener('click', closeProfessionalModal);

    const profForm = document.getElementById('professionalForm');
    if(profForm) profForm.addEventListener('submit', saveProfessional);
    
    // Delegación de eventos para los botones de editar y eliminar en la lista
    const adminList = document.getElementById('adminProfessionalsList');
    if(adminList) {
        adminList.addEventListener('click', (e) => {
            if (e.target.classList.contains('edit-btn')) {
                openProfessionalModal(e.target.dataset.id);
            }
            if (e.target.classList.contains('delete-btn')) {
                deleteProfessional(e.target.dataset.id);
            }
        });
    }
          
            // Setup search
            setupSearch();
        }
        
        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
